name: Tests

on:
  workflow_call:
    microk8s-channel:
      description: "Microk8s channel e.g. 1.28/stable"
      required: false
      default: "1.28/stable"
      type: string
    python-version:
      description: "Version of python to install. If empty, the workflow will not install and will use machine's default"
      default: "3.10"
      required: false
      type: string
    

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Install dependencies
        run: python3 -m pip install tox
      - name: Run linters
        run: tox -e lint

  unit-test:
    name: Unit tests
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Install dependencies
        run: python -m pip install tox
      - name: Run tests
        run: tox -e unit

  integration:
    name: Integration tests
    runs-on: ubuntu-22.04
    needs: [lint, unit-test]  # Depends on lint and unit-test jobs
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Remove once https://github.com/canonical/bundle-kubeflow/issues/761
      # is resolved and applied to all ROCKs repositories
      - name: Install python version from input
        if: ${{ inputs.python-version }}
        run: |
          sudo add-apt-repository ppa:deadsnakes/ppa -y
          sudo apt update -y
          VERSION=${{ inputs.python-version }}
          sudo apt install python${{ inputs.python-version }} python${{ inputs.python-version }}-distutils python${{ inputs.python-version }}-venv -y
          wget https://bootstrap.pypa.io/get-pip.py
          python${{ inputs.python-version }} get-pip.py
          python${{ inputs.python-version }} -m pip install tox
      
      - name: Setup operator environment
        uses: charmed-kubernetes/actions-operator@main
        with:
          provider: microk8s
          channel: ${{ inputs.microk8s-channel }}
          microk8s-addons: "hostpath-storage"

      - name: Install library
        run: tox -e integration -- -vv -s
      
      - name: Setup tmate session
        uses: mxschmitt/action-tmate@v3
        timeout-minutes: 15 # This will allow to open a sesion for max 15 minutes
